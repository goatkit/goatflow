# Podman-compatible compose file (also works with Docker)
# No version specified for better Podman compatibility

services:
  # MariaDB Database - Secure non-root container for OTRS compatibility
  mariadb:
    image: docker.io/mariadb:11
    container_name: goatflow-mariadb
    user: "999:999" # Run as mysql user (standard for MariaDB)
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      # MariaDB specific settings for better performance
      MYSQL_INITDB_SKIP_TZINFO: 1
    ports:
      - "${DB_PORT:-3306}:3306"
    expose:
      - "3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./docker/mariadb/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro,Z
      - ./docker/mariadb/healthcheck.sh:/usr/local/bin/healthcheck.sh:ro,Z
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - goatflow-network
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: goatflow-postgres
  #   environment:
  #     POSTGRES_DB: ${DB_NAME}
  #     POSTGRES_USER: ${DB_USER}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD}
  #     # Pass APP_ENV to prevent test database creation in production
  #     APP_ENV: ${APP_ENV:-development}
  #   ports:
  #     - "${DB_PORT:-5432}:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #     # Init script handles any username and creates test database safely
  #     - ./docker/postgres/01-init-databases.sql:/docker-entrypoint-initdb.d/01-init-databases.sql:ro,Z
  #   healthcheck:
  #     test: ["CMD", "pg_isready", "-U", "${DB_USER}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - goatflow-network

  # Valkey Cache - High-performance Redis-compatible cache
  valkey:
    image: docker.io/valkey/valkey:7-alpine
    container_name: goatflow-valkey
    user: "999:1000" # Run as valkey user (standard for Valkey)
    ports:
      - "${VALKEY_PORT:-6388}:6379"
    volumes:
      - valkey_data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - goatflow-network

  # GoatFlow Backend - Main application server
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GO_IMAGE: ${GO_IMAGE}
        UID: ${HOST_UID:-1000}
        GID: ${HOST_GID:-1000}
    image: ghcr.io/goatkit/goatflow:${GOATFLOW_VERSION:-latest}
    command: >
      sh -c "
        # Generate self-signed certificates if they don't exist
        if [ ! -f /app/certs/server.crt ] || [ ! -f /app/certs/server.key ]; then
          echo 'üîê Generating self-signed TLS certificates...'
          mkdir -p /app/certs
          openssl req -x509 -newkey rsa:4096 -keyout /app/certs/server.key -out /app/certs/server.crt -days 365 -nodes -subj '/CN=goatflow-backend'
          echo '‚úÖ TLS certificates generated'
        fi
        # Run database migrations automatically
        echo 'üì¶ Running database migrations...'
        if [ \"\$DB_DRIVER\" = 'postgres' ]; then
          ./migrate -path /app/migrations/postgres -database \"postgres://\$DB_USER:\$DB_PASSWORD@\$DB_HOST:\$DB_PORT/\$DB_NAME?sslmode=disable\" up
        else
          ./migrate -path /app/migrations/mysql -database \"mysql://\$DB_USER:\$DB_PASSWORD@tcp(\$DB_HOST:\$DB_PORT)/\$DB_NAME?multiStatements=true\" up
        fi
        echo '‚úÖ Database migrations complete'
        # Start the application
        ./goats
      "
    environment:
      # Enable YAML-based routing by default
      ENABLE_YAML_ROUTING: ${ENABLE_YAML_ROUTING:-true}
      ROUTES_DIR: /app/routes
      APP_ENV: ${APP_ENV:-development}
      APP_PORT: ${APP_PORT:-8080}
      DB_DRIVER: ${DB_DRIVER:-mariadb}
      DB_HOST: ${DB_HOST:-mariadb}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      # JWT secret must be provided via environment (.env or shell); no unsafe default here
      JWT_SECRET: ${JWT_SECRET}
      PASSWORD_HASH_TYPE: ${PASSWORD_HASH_TYPE:-sha256}
      MIGRATE_PASSWORD_HASHES: ${MIGRATE_PASSWORD_HASHES:-false}
      STORAGE_PATH: ${STORAGE_PATH:-/app/storage}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10MB}
      ALLOWED_FILE_TYPES: ${ALLOWED_FILE_TYPES:-pdf,doc,docx,txt,png,jpg,jpeg,gif,zip}
      # Plugin system (defaults set in Dockerfile, override here if needed)
      # GOATFLOW_PLUGIN_LAZY_LOAD: ${GOATFLOW_PLUGIN_LAZY_LOAD:-true}
      # GOATFLOW_PLUGIN_HOT_RELOAD: ${GOATFLOW_PLUGIN_HOT_RELOAD:-false}
      # Plugin-specific config: set GOATFLOW_PLUGIN_<NAME>_<KEY> env vars as needed
      # e.g. GOATFLOW_PLUGIN_GOATFICTUS_LLM_URL=http://host.docker.internal:11434
      # TLS configuration
      TLS_CERT_FILE: /app/certs/server.crt
      TLS_KEY_FILE: /app/certs/server.key
    ports:
      - "${BACKEND_PORT:-8081}:8080"
    volumes:
      - ./storage:${STORAGE_PATH:-/app/storage}:Z
      - goatflow_certs:/app/certs
      - goatflow_plugins:/app/config/plugins
    depends_on:
      mariadb:
        condition: service_healthy
      valkey:
        condition: service_healthy
    networks:
      - goatflow-network
    # Production binary runs automatically from Dockerfile CMD
    # For development hot reload, volume mount handles code changes

  # GoatFlow Customer Frontend - Dedicated customer-facing instance
  customer-fe:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GO_IMAGE: ${GO_IMAGE}
        UID: ${HOST_UID:-1000}
        GID: ${HOST_GID:-1000}
    image: ghcr.io/goatkit/goatflow:${GOATFLOW_VERSION:-latest}
    container_name: goatflow-customer-fe
    command: >
      sh -c "
        if [ ! -f /app/certs/server.crt ] || [ ! -f /app/certs/server.key ]; then
          echo 'üîê Generating self-signed TLS certificates...'
          mkdir -p /app/certs
          openssl req -x509 -newkey rsa:4096 -keyout /app/certs/server.key -out /app/certs/server.crt -days 365 -nodes -subj '/CN=goatflow-customer-fe'
          echo '‚úÖ TLS certificates generated'
        fi
        ./goats
      "
    environment:
      ENABLE_YAML_ROUTING: ${ENABLE_YAML_ROUTING:-true}
      ROUTES_DIR: /app/routes
      APP_ENV: ${APP_ENV:-development}
      APP_PORT: ${CUSTOMER_FE_APP_PORT:-8080}
      ROOT_REDIRECT_PATH: /customer
      CUSTOMER_FE_ONLY: "true"
      DB_DRIVER: ${DB_DRIVER:-mariadb}
      DB_HOST: ${DB_HOST:-mariadb}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      VALKEY_HOST: valkey
      VALKEY_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      PASSWORD_HASH_TYPE: ${PASSWORD_HASH_TYPE:-sha256}
      MIGRATE_PASSWORD_HASHES: ${MIGRATE_PASSWORD_HASHES:-false}
      STORAGE_PATH: ${STORAGE_PATH:-/app/storage}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10MB}
      ALLOWED_FILE_TYPES: ${ALLOWED_FILE_TYPES:-pdf,doc,docx,txt,png,jpg,jpeg,gif,zip}
      TLS_CERT_FILE: /app/certs/server.crt
      TLS_KEY_FILE: /app/certs/server.key
    ports:
      - "${CUSTOMER_FE_PORT:-8083}:${CUSTOMER_FE_APP_PORT:-8080}"
    volumes:
      - ./storage:${STORAGE_PATH:-/app/storage}:Z
      - ./docker/frontend/healthcheck.sh:/usr/local/bin/healthcheck.sh:ro,Z
      - goatflow_certs:/app/certs
    depends_on:
      mariadb:
        condition: service_healthy
      valkey:
        condition: service_healthy
    networks:
      - goatflow-network
    healthcheck:
      test: ["CMD", "healthcheck.sh"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 5

  # GoatFlow Runner - Background task processor
  runner:
    image: ghcr.io/goatkit/goatflow:${GOATFLOW_VERSION:-latest}
    container_name: goatflow-runner
    command: ["./goats", "-mode", "runner"]
    environment:
      DB_DRIVER: ${DB_DRIVER:-mariadb}
      DB_HOST: ${DB_HOST:-mariadb}
      DB_PORT: ${DB_PORT:-3306}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      # Email configuration for queue processing
      GOATFLOW_EMAIL_SMTP_HOST: ${SMTP_HOST:-smtp4dev}
      GOATFLOW_EMAIL_SMTP_PORT: ${SMTP_PORT:-25}
      GOATFLOW_EMAIL_SMTP_USER: ${SMTP_USER}
      GOATFLOW_EMAIL_SMTP_PASSWORD: ${SMTP_PASSWORD}
      GOATFLOW_EMAIL_SMTP_TLS: ${SMTP_TLS:-false}
      GOATFLOW_EMAIL_SMTP_SKIP_VERIFY: ${SMTP_SKIP_VERIFY:-true}
      GOATFLOW_EMAIL_FROM: ${EMAIL_FROM:-noreply@goatflow.local}
      GOATFLOW_EMAIL_ENABLED: ${EMAIL_ENABLED:-true}
    depends_on:
      mariadb:
        condition: service_healthy
      smtp4dev:
        condition: service_started
    networks:
      - goatflow-network
    restart: unless-stopped

  # smtp4dev - Full email sandbox (SMTP/IMAP/POP3 + Web UI)
  smtp4dev:
    image: docker.io/rnwood/smtp4dev:latest
    container_name: goatflow-smtp4dev
    environment:
      # Persist mail data on restarts
      ServerOptions__HostName: ${SMTP4DEV_HOSTNAME:-goatflow.local}
      ServerOptions__TlsOptions__EnableStartTls: "true"
    ports:
      - "${SMTP4DEV_SMTP_PORT:-1025}:25"   # SMTP
      - "${SMTP4DEV_IMAP_PORT:-1143}:143"  # IMAP
      - "${SMTP4DEV_POP3_PORT:-1110}:110"  # POP3
      - "${SMTP4DEV_UI_PORT:-8025}:80"     # Web UI
    volumes:
      - smtp4dev_data:/smtp4dev
    networks:
      - goatflow-network

  # Valkey Test Cache - Separate cache for test environment
  valkey-test:
    image: docker.io/valkey/valkey:7-alpine
    container_name: goatflow-valkey-test
    user: "999:1000" # Run as valkey user (standard for Valkey)
    ports:
      - "${VALKEY_TEST_PORT:-6389}:6379"
    volumes:
      - valkey_test_data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - goatflow-network
    profiles: ["testdb"]

  # GoatFlow Backend Test - Dedicated test backend connecting to test databases
  backend-test:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GO_IMAGE: ${GO_IMAGE}
        UID: ${HOST_UID:-1000}
        GID: ${HOST_GID:-1000}
    image: ghcr.io/goatkit/goatflow:${GOATFLOW_VERSION:-latest}
    container_name: goatflow-backend-test
    command: >
      sh -c "
        # Generate self-signed certificates if they don't exist
        if [ ! -f /app/certs/server.crt ] || [ ! -f /app/certs/server.key ]; then
          echo 'üîê Generating self-signed TLS certificates...'
          mkdir -p /app/certs
          openssl req -x509 -newkey rsa:4096 -keyout /app/certs/server.key -out /app/certs/server.crt -days 365 -nodes -subj '/CN=goatflow-backend-test'
          echo '‚úÖ TLS certificates generated'
        fi
        # Start the application
        ./goats
      "
    environment:
      # Enable YAML-based routing by default
      ENABLE_YAML_ROUTING: ${ENABLE_YAML_ROUTING:-true}
      ROUTES_DIR: /app/routes
      APP_ENV: test
      APP_PORT: ${APP_PORT:-8080}
      # Test database configuration - credentials must be in .env
      DB_DRIVER: ${TEST_DB_DRIVER}
      DB_HOST: ${TEST_DB_MYSQL_HOST}
      DB_PORT: ${TEST_DB_MYSQL_PORT:-3308}
      DB_NAME: ${TEST_DB_MYSQL_NAME}
      DB_USER: ${TEST_DB_MYSQL_USER}
      DB_PASSWORD: ${TEST_DB_MYSQL_PASSWORD}
      # Test cache configuration
      VALKEY_HOST: valkey-test
      VALKEY_PORT: 6379
      # JWT secret must be provided via environment (.env or shell)
      JWT_SECRET: ${JWT_SECRET}
      PASSWORD_HASH_TYPE: ${PASSWORD_HASH_TYPE:-sha256}
      MIGRATE_PASSWORD_HASHES: ${MIGRATE_PASSWORD_HASHES:-false}
      STORAGE_PATH: ${STORAGE_PATH:-/app/storage}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10MB}
      ALLOWED_FILE_TYPES: ${ALLOWED_FILE_TYPES:-pdf,doc,docx,txt,png,jpg,jpeg,gif,zip}
      # TLS configuration
      TLS_CERT_FILE: /app/certs/server.crt
      TLS_KEY_FILE: /app/certs/server.key
    ports:
      - "${BACKEND_TEST_PORT:-8082}:8080"
    volumes:
      - ./storage:${STORAGE_PATH:-/app/storage}:Z
      - goatflow_certs:/app/certs
    depends_on:
      mariadb-test:
        condition: service_healthy
      smtp4dev:
        condition: service_started
      valkey-test:
        condition: service_healthy
    networks:
      - goatflow-network
    profiles: ["testdb"]

  # GoatFlow Runner Test - Background task processor for test environment
  runner-test:
    image: ghcr.io/goatkit/goatflow:${GOATFLOW_VERSION:-latest}
    container_name: goatflow-runner-test
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    command: ["./goats", "-mode", "runner"]
    environment:
      # Test database configuration - credentials must be in .env
      DB_DRIVER: ${TEST_DB_DRIVER}
      DB_HOST: ${TEST_DB_MYSQL_HOST}
      DB_PORT: ${TEST_DB_MYSQL_PORT:-3308}
      DB_NAME: ${TEST_DB_MYSQL_NAME}
      DB_USER: ${TEST_DB_MYSQL_USER}
      DB_PASSWORD: ${TEST_DB_MYSQL_PASSWORD}
      # Email configuration for queue processing
      GOATFLOW_EMAIL_SMTP_HOST: ${SMTP_HOST:-smtp4dev}
      GOATFLOW_EMAIL_SMTP_PORT: ${SMTP_PORT:-25}
      GOATFLOW_EMAIL_SMTP_USER: ${SMTP_USER}
      GOATFLOW_EMAIL_SMTP_PASSWORD: ${SMTP_PASSWORD}
      GOATFLOW_EMAIL_SMTP_TLS: ${SMTP_TLS:-false}
      GOATFLOW_EMAIL_SMTP_SKIP_VERIFY: ${SMTP_SKIP_VERIFY:-true}
      GOATFLOW_EMAIL_FROM: ${EMAIL_FROM:-noreply@goatflow.local}
      GOATFLOW_EMAIL_ENABLED: ${EMAIL_ENABLED:-true}
    depends_on:
      mariadb-test:
        condition: service_healthy
    networks:
      - goatflow-network
    restart: unless-stopped
    profiles: ["testdb"]

  # GoatFlow Customer Frontend Test - Dedicated customer-facing instance for test stack
  customer-fe-test:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        GO_IMAGE: ${GO_IMAGE}
        UID: ${HOST_UID:-1000}
        GID: ${HOST_GID:-1000}
    image: ghcr.io/goatkit/goatflow:${GOATFLOW_VERSION:-latest}
    container_name: goatflow-customer-fe-test
    command: >
      sh -c "
        if [ ! -f /app/certs/server.crt ] || [ ! -f /app/certs/server.key ]; then
          echo 'üîê Generating self-signed TLS certificates...'
          mkdir -p /app/certs
          openssl req -x509 -newkey rsa:4096 -keyout /app/certs/server.key -out /app/certs/server.crt -days 365 -nodes -subj '/CN=goatflow-customer-fe-test'
          echo '‚úÖ TLS certificates generated'
        fi
        ./goats
      "
    environment:
      ENABLE_YAML_ROUTING: ${ENABLE_YAML_ROUTING:-true}
      ROUTES_DIR: /app/routes
      APP_ENV: test
      APP_PORT: ${CUSTOMER_FE_TEST_APP_PORT:-8080}
      ROOT_REDIRECT_PATH: /customer
      CUSTOMER_FE_ONLY: "true"
      # Test database configuration - credentials must be in .env
      DB_DRIVER: ${TEST_DB_DRIVER}
      DB_HOST: ${TEST_DB_MYSQL_HOST}
      DB_PORT: ${TEST_DB_MYSQL_PORT:-3308}
      DB_NAME: ${TEST_DB_MYSQL_NAME}
      DB_USER: ${TEST_DB_MYSQL_USER}
      DB_PASSWORD: ${TEST_DB_MYSQL_PASSWORD}
      VALKEY_HOST: valkey-test
      VALKEY_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      PASSWORD_HASH_TYPE: ${PASSWORD_HASH_TYPE:-sha256}
      MIGRATE_PASSWORD_HASHES: ${MIGRATE_PASSWORD_HASHES:-false}
      STORAGE_PATH: ${STORAGE_PATH:-/app/storage}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10MB}
      ALLOWED_FILE_TYPES: ${ALLOWED_FILE_TYPES:-pdf,doc,docx,txt,png,jpg,jpeg,gif,zip}
      TLS_CERT_FILE: /app/certs/server.crt
      TLS_KEY_FILE: /app/certs/server.key
    ports:
      - "${CUSTOMER_FE_TEST_PORT:-8084}:${CUSTOMER_FE_TEST_APP_PORT:-8080}"
    volumes:
      - ./storage:${STORAGE_PATH:-/app/storage}:Z
      - goatflow_certs:/app/certs
    depends_on:
      valkey-test:
        condition: service_healthy
      mariadb-test:
        condition: service_healthy
    networks:
      - goatflow-network
    profiles: ["testdb"]

  # Temporal Workflow Engine - COMMENTED OUT until code is implemented
  # temporal:
  #   image: temporalio/auto-setup:1.22.4
  #   container_name: goatflow-temporal
  #   depends_on:
  #     - postgres
  #   environment:
  #     - DB=postgresql
  #     - DB_PORT=5432
  #     - POSTGRES_USER=${DB_USER}
  #     - POSTGRES_PWD=${DB_PASSWORD}
  #     - POSTGRES_SEEDS=postgres
  #     - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig.yaml
  #   ports:
  #     - "${TEMPORAL_PORT:-7233}:7233"
  #   volumes:
  #     - ./docker/temporal/dynamicconfig.yaml:/etc/temporal/config/dynamicconfig.yaml:ro,Z
  #   networks:
  #     - goatflow-network

  # Temporal Web UI - COMMENTED OUT until code is implemented
  # temporal-ui:
  #   image: temporalio/ui:2.21.3
  #   container_name: goatflow-temporal-ui
  #   depends_on:
  #     - temporal
  #   environment:
  #     - TEMPORAL_ADDRESS=temporal:7233
  #     - TEMPORAL_CORS_ORIGINS=http://localhost:3000
  #   ports:
  #     - "${TEMPORAL_UI_PORT:-8088}:8080"
  #   networks:
  #     - goatflow-network

  # Zinc Search Engine (Elasticsearch compatible) - COMMENTED OUT until code is implemented
  # zinc:
  #   image: public.ecr.aws/zinclabs/zincsearch:latest
  #   container_name: goatflow-zinc
  #   environment:
  #     - ZINC_FIRST_ADMIN_USER=${ZINC_USER}
  #     - ZINC_FIRST_ADMIN_PASSWORD=${ZINC_PASSWORD}
  #     - ZINC_DATA_PATH=/data
  #   ports:
  #     - "${ZINC_PORT:-4080}:4080"
  #   volumes:
  #     - zinc_data:/data
  #   networks:
  #     - goatflow-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:4080/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # OpenLDAP Server for Testing - COMMENTED OUT until code is implemented
  # openldap:
  #   image: osixia/openldap:1.5.0
  #   container_name: goatflow-openldap
  #   environment:
  #     - LDAP_ORGANISATION=GoatFlow Test Corp
  #     - LDAP_DOMAIN=goatflow.local
  #     - LDAP_ADMIN_PASSWORD=${LDAP_ADMIN_PASSWORD}
  #     - LDAP_CONFIG_PASSWORD=${LDAP_CONFIG_PASSWORD}
  #     - LDAP_READONLY_USER=true
  #     - LDAP_READONLY_USER_USERNAME=readonly
  #     - LDAP_READONLY_USER_PASSWORD=${LDAP_READONLY_PASSWORD}
  #     - LDAP_RFC2307BIS_SCHEMA=false
  #     - LDAP_BACKEND=mdb
  #     - LDAP_TLS=true
  #     - LDAP_TLS_CRT_FILENAME=ldap.crt
  #     - LDAP_TLS_KEY_FILENAME=ldap.key
  #     - LDAP_TLS_DH_PARAM_FILENAME=dhparam.pem
  #     - LDAP_TLS_CA_CRT_FILENAME=ca.crt
  #     - LDAP_TLS_ENFORCE=false
  #     - LDAP_TLS_CIPHER_SUITE=SECURE256:-VERS-SSL3.0
  #     - LDAP_TLS_PROTOCOL_MIN=3.1
  #     - LDAP_TLS_VERIFY_CLIENT=demand
  #     - LDAP_REPLICATION=false
  #     - KEEP_EXISTING_CONFIG=false
  #     - LDAP_REMOVE_CONFIG_AFTER_SETUP=true
  #     - LDAP_SSL_HELPER_PREFIX=ldap
  #   ports:
  #     - "${LDAP_PORT:-389}:389"
  #     - "${LDAPS_PORT:-636}:636"
  #   volumes:
  #     - ldap_data:/var/lib/ldap
  #     - ldap_config:/etc/ldap/slapd.d
  #     - ./docker/ldap/bootstrap:/container/service/slapd/assets/config/bootstrap/ldif/custom:Z
  #   command: --copy-service --loglevel debug
  #   networks:
  #     - goatflow-network
  #   healthcheck:
  #     test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "dc=goatflow,dc=local", "-D", "cn=admin,dc=goatflow,dc=local", "-w", "${LDAP_ADMIN_PASSWORD}", "(objectclass=*)", "dn"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 60s

  # phpLDAPadmin for LDAP Management (Optional) - COMMENTED OUT until code is implemented
  # phpldapadmin:
  #   image: osixia/phpldapadmin:latest
  #   container_name: goatflow-phpldapadmin
  #   environment:
  #     - PHPLDAPADMIN_LDAP_HOSTS=openldap
  #     - PHPLDAPADMIN_HTTPS=false
  #   ports:
  #     - "${PHPLDAPADMIN_PORT:-8091}:80"
  #   depends_on:
  #     - openldap
  #   networks:
  #     - goatflow-network
  #   profiles:
  #     - tools

    # Adminer - Database management tool
  adminer:
    image: docker.io/adminer:latest
    container_name: goatflow-adminer
    ports:
      - "${ADMINER_PORT:-8090}:8080"
    depends_on:
      - mariadb
    networks:
      - goatflow-network
    profiles:
      - tools

  # Container-first test runner
  goatflow-tests:
    build:
      context: .
      dockerfile: Dockerfile.tests
      args:
        GO_IMAGE: ${GO_IMAGE}
    container_name: goatflow-tests
    environment:
      GOATFLOW_HOST: http://goatflow-backend:8080
      VERBOSE: "true"
      OUTPUT_DIR: /app/results
    volumes:
      - ./test-results:/app/results:Z
    depends_on:
      - backend
    networks:
      - goatflow-network
    profiles: ["testing"]

  # Development toolbox with all-in-one development tools
  toolbox:
    build:
      context: .
      dockerfile: Dockerfile.toolbox
      args:
        GO_IMAGE: ${GO_IMAGE}
        UID: ${HOST_UID:-1000}
        GID: ${HOST_GID:-1000}
    image: ghcr.io/goatkit/goatflow/toolbox:${GOATFLOW_VERSION:-latest}
    container_name: goatflow-toolbox
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}" # Match host user to avoid root-owned artifacts
    environment:
      # Go development environment - cache in separate volume (not overlaid on workspace)
      GOCACHE: /cache/go-build
      GOMODCACHE: /cache/go-mod
      GOLANGCI_LINT_CACHE: /cache/golangci-lint
      BUN_INSTALL_CACHE_DIR: /cache/bun
      XDG_CACHE_HOME: /cache/xdg
      GOTOOLCHAIN: local
      GOTELEMETRY: off
      PATH: /usr/local/go/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
      # Test database environment for integration tests - credentials must be in .env
      APP_ENV: test
      DB_DRIVER: ${TEST_DB_DRIVER}
      DB_HOST: ${TEST_DB_MYSQL_HOST}
      DB_PORT: 3306
      DB_NAME: ${TEST_DB_MYSQL_NAME}
      DB_USER: ${TEST_DB_MYSQL_USER}
      DB_PASSWORD: ${TEST_DB_MYSQL_PASSWORD}
      TEST_DB_DRIVER: ${TEST_DB_DRIVER}
      TEST_DB_HOST: ${TEST_DB_MYSQL_HOST}
      TEST_DB_PORT: 3306
      TEST_DB_NAME: ${TEST_DB_MYSQL_NAME}
      TEST_DB_USER: ${TEST_DB_MYSQL_USER}
      TEST_DB_PASSWORD: ${TEST_DB_MYSQL_PASSWORD}
      GOATFLOW_TEST_DB_READY: "1"
    volumes:
      - .:/workspace:Z
      - goatflow_cache:/cache
    working_dir: /workspace
    networks:
      - goatflow-network
    profiles: ["toolbox"]
    # Interactive shell by default
    stdin_open: true
    tty: true
    command: ["/bin/bash"]

networks:
  goatflow-network:
    driver: bridge

volumes:
  mariadb_data:
  # postgres_data:     # Commented out - using MariaDB instead
  valkey_data:
  valkey_test_data:
  goatflow_cache:
  goatflow_certs:
  goatflow_plugins:
  smtp4dev_data:
  # zinc_data:         # Commented out - zinc service disabled
  # temporal_data:     # Commented out - temporal service disabled
  # ldap_data:         # Commented out - openldap service disabled
  # ldap_config:       # Commented out - openldap service disabled
